var Me=Object.defineProperty;var Re=(t,e,s)=>e in t?Me(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var u=(t,e,s)=>Re(t,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(i){if(i.ep)return;i.ep=!0;const n=s(i);fetch(i.href,n)}})();class Ie{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(e,s){let r=this.length++;for(;r>0;){const i=r-1>>1,n=this.values[i];if(s>=n)break;this.ids[r]=this.ids[i],this.values[r]=n,r=i}this.ids[r]=e,this.values[r]=s}pop(){if(this.length===0)return;const e=this.ids[0];if(this.length--,this.length>0){const s=this.ids[0]=this.ids[this.length],r=this.values[0]=this.values[this.length],i=this.length>>1;let n=0;for(;n<i;){let a=(n<<1)+1;const c=a+1;let o=this.ids[a],h=this.values[a];const f=this.values[c];if(c<this.length&&f<h&&(a=c,o=this.ids[c],h=f),h>=r)break;this.ids[n]=o,this.values[n]=h,n=a}this.ids[n]=s,this.values[n]=r}return e}peek(){if(this.length!==0)return this.ids[0]}peekValue(){if(this.length!==0)return this.values[0]}shrink(){this.ids.length=this.values.length=this.length}}class Oe{constructor(e){u(this,"template");u(this,"items",[]);this.template=e}create(){return this.items.pop()??new this.template}release(e){this.items.push(e)}}class P{constructor(){u(this,"run");u(this,"timer");u(this,"cancelled")}init(e,s){return this.run=s,this.timer=e,this.cancelled=!1,this}execute(){this.timer.pools.get(P).release(this),!this.cancelled&&this.run(this.timer)}cancel(){this.cancelled=!0}}class ie{constructor(){u(this,"run");u(this,"timer");u(this,"cancelled");u(this,"onFrameEnd",()=>this.timer.schedule(this,0))}init(e,s){return this.run=s,this.timer=e,this.cancelled=!1,this.timer.events.frameEnd.add(this.onFrameEnd),this}execute(){if(this.cancelled){this.timer.pools.get(P).release(this),this.timer.events.frameEnd.delete(this.onFrameEnd);return}this.run(this.timer)}cancel(){this.cancelled=!0}}class z{constructor(){u(this,"run");u(this,"timer");u(this,"cancelled");u(this,"interval")}init(e,s,r){return this.run=s,this.timer=e,this.interval=r,this.cancelled=!1,this}execute(){if(this.cancelled){this.timer.pools.get(z).release(this);return}this.timer.schedule(this,this.interval),this.run(this.timer)}cancel(){this.cancelled=!0}}class Le{constructor(){u(this,"executionTime",0);u(this,"lastExecutionTime",0);u(this,"frameExecutionTime",0);u(this,"speed",0);u(this,"playing",!1);u(this,"requestID",-1);u(this,"queue",new Ie);u(this,"pools",new Map);u(this,"events",{frameStart:new Set,frameEnd:new Set});u(this,"loop",(e=performance.now())=>{this.requestID=requestAnimationFrame(this.loop),this.update(e)});[P,z,ie].forEach(e=>this.pools.set(e,new Oe(e)))}get now(){return this.executionTime}schedule(e,s=1e3){this.queue.push(e,this.executionTime+s)}animation(e,s=1e3){const r=this.pools.get(ie).create();return r.init(this,e),this.schedule(r,s),r}delay(e,s=1e3){const r=this.pools.get(P).create();return r.init(this,e),this.schedule(r,s),r}interval(e,s=1e3,r=1e3){const i=this.pools.get(z).create();return i.init(this,e,r),this.schedule(i,s),i}update(e=performance.now()){const s=e-this.lastExecutionTime;this.lastExecutionTime=e,this.events.frameStart.forEach(r=>r(this)),this.frameExecutionTime+=s*this.speed;do{const r=this.queue.peekValue()??1/0;if(r>this.frameExecutionTime)break;this.executionTime=r,this.queue.pop().execute(this)}while(!0);this.executionTime=this.frameExecutionTime,this.events.frameEnd.forEach(r=>r(this))}play(e=1){this.playing||e<0||(this.playing=!0,this.speed=e,this.lastExecutionTime=performance.now(),this.requestID=requestAnimationFrame(this.loop))}stop(){this.playing&&(this.playing=!1,cancelAnimationFrame(this.requestID),this.frameExecutionTime=this.executionTime)}clear(){this.queue.clear()}}class Pe{constructor({autoStart:e=!0,frameRate:s=1e3/60}={}){u(this,"timer");u(this,"_scenes",new Set);u(this,"_cleanups",new Map);u(this,"render",()=>this._scenes.forEach(e=>e.render()));u(this,"update",()=>this._scenes.forEach(e=>e.update()));this.timer=new Le,this.timer.animation(this.render,0),this.timer.interval(this.update,0,s),e&&this.timer.play()}async enterScene(e){if(this._scenes.has(e))return!1;const s=await e.enter();return this._scenes.add(e),s&&this._cleanups.set(e,s),!0}async leaveScene(e){if(!this._scenes.has(e))return!1;const s=this._cleanups.get(e);return s&&(await s(),this._cleanups.delete(e)),await e.leave(),this._scenes.delete(e),!0}}var C={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},ae={i8:"Int8",ui8:"Uint8",ui8c:"Uint8Clamped",i16:"Int16",ui16:"Uint16",i32:"Int32",ui32:"Uint32",eid:"Uint32",f32:"Float32",f64:"Float64"},S={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},oe={uint8:2**8,uint16:2**16,uint32:2**32},_e=t=>e=>Math.ceil(e/t)*t,ke=_e(4),Be=Symbol("storeRef"),V=Symbol("storeSize"),Ue=Symbol("storeMaps"),g=Symbol("storeFlattened"),B=Symbol("storeBase"),ze=Symbol("storeType"),fe=Symbol("storeArrayElementCounts"),U=Symbol("storeSubarrays"),me=Symbol("subarrayCursors"),Fe=Symbol("subarray"),W=Symbol("parentArray"),pe=Symbol("tagStore"),ce=Symbol("indexType"),ue=Symbol("indexBytes"),ye=Symbol("isEidType"),p={},Ne=(t,e)=>{if(ArrayBuffer.isView(t))t[e]=t.slice(0);else{const s=t[W].slice(0);t[e]=t.map((r,i)=>{const{length:n}=t[i],a=n*i,c=a+n;return s.subarray(a,c)})}},je=(t,e)=>{t[g]&&t[g].forEach(s=>{ArrayBuffer.isView(s)?s[e]=0:s[e].fill(0)})},qe=(t,e)=>{const s=e*S[t].BYTES_PER_ELEMENT,r=new ArrayBuffer(s),i=new S[t](r);return i[ye]=t===C.eid,i},we=(t,e,s)=>{const r=t[V],i=Array(r).fill(0);i[ze]=e,i[ye]=e===C.eid;const n=t[me],a=s<=oe.uint8?C.ui8:s<=oe.uint16?C.ui16:C.ui32;if(!s)throw new Error("bitECS - Must define component array length");if(!S[e])throw new Error(`bitECS - Invalid component array property type ${e}`);if(!t[U][e]){const h=t[fe][e],f=new S[e](ke(h*r));f[ce]=ae[a],f[ue]=S[a].BYTES_PER_ELEMENT,t[U][e]=f}const c=n[e],o=c+r*s;n[e]=o,i[W]=t[U][e].subarray(c,o);for(let h=0;h<r;h++){const f=s*h,D=f+s;i[h]=i[W].subarray(f,D),i[h][ce]=ae[a],i[h][ue]=S[a].BYTES_PER_ELEMENT,i[h][Fe]=!0}return i},le=t=>Array.isArray(t)&&typeof t[0]=="string"&&typeof t[1]=="number",De=(t,e)=>{const s=Symbol("store");if(!t||!Object.keys(t).length)return p[s]={[V]:e,[pe]:!0,[B]:()=>p[s]},p[s];t=JSON.parse(JSON.stringify(t));const r={},i=a=>{const c=Object.keys(a);for(const o of c)le(a[o])?(r[a[o][0]]||(r[a[o][0]]=0),r[a[o][0]]+=a[o][1]):a[o]instanceof Object&&i(a[o])};i(t);const n={[V]:e,[Ue]:{},[U]:{},[Be]:s,[me]:Object.keys(S).reduce((a,c)=>({...a,[c]:0}),{}),[g]:[],[fe]:r};if(t instanceof Object&&Object.keys(t).length){const a=(c,o)=>{if(typeof c[o]=="string")c[o]=qe(c[o],e),c[o][B]=()=>p[s],n[g].push(c[o]);else if(le(c[o])){const[h,f]=c[o];c[o]=we(n,h,f),c[o][B]=()=>p[s],n[g].push(c[o])}else c[o]instanceof Object&&(c[o]=Object.keys(c[o]).reduce(a,c[o]));return c};return p[s]=Object.assign(Object.keys(t).reduce(a,t),n),p[s][B]=()=>p[s],p[s]}},$=()=>{const t=[],e=[];t.sort=function(a){const c=Array.prototype.sort.call(this,a);for(let o=0;o<t.length;o++)e[t[o]]=o;return c};const s=a=>t[e[a]]===a;return{add:a=>{s(a)||(e[a]=t.push(a)-1)},remove:a=>{if(!s(a))return;const c=e[a],o=t.pop();o!==a&&(t[c]=o,e[o]=c)},has:s,sparse:e,dense:t,reset:()=>{t.length=0,e.length=0}}},v=Symbol("entityMasks"),q=Symbol("entityComponents"),b=Symbol("entitySparseSet"),R=Symbol("entityArray"),Qe=1e5,Y=0,de=Qe,J=()=>de,M=[],Ve=.01,We=Ve,Ye=()=>Y,Ge=new Map,He=t=>{const e=t[se]?M.length?M.shift():Y++:M.length>Math.round(de*We)?M.shift():Y++;if(e>t[te])throw new Error("bitECS - max entities reached");return t[b].add(e),Ge.set(e,t),t[K].forEach(s=>{Z(t,s,e)&&ee(s,e)}),t[q].set(e,new Set),e},ve=(t,e)=>{if(t[b].has(e)){t[w].forEach(s=>{ge(t,s,e)}),t[se]||M.push(e),t[b].remove(e),t[q].delete(e),t[be].delete(t[H].get(e)),t[H].delete(e);for(let s=0;s<t[v].length;s++)t[v][s][e]=0}},Je=Symbol("$modifier"),w=Symbol("queries"),K=Symbol("notQueries"),Ke=Symbol("queryAny"),Xe=Symbol("queryAll"),Ze=Symbol("queryNone"),F=Symbol("queryMap"),I=Symbol("$dirtyQueries"),Se=Symbol("queryComponents"),et=(t,e)=>{const s=[],r=[],i=[];e[Se].forEach(l=>{if(typeof l=="function"&&l[Je]){const[m,ne]=l();t[y].has(m)||G(t,m),ne==="not"&&r.push(m),ne==="changed"&&(i.push(m),s.push(m))}else t[y].has(l)||G(t,l),s.push(l)});const n=l=>t[y].get(l),a=s.concat(r).map(n),c=$(),o=[],h=[],f=$(),D=$(),Ee=$(),xe=a.map(l=>l.generationId).reduce((l,m)=>(l.includes(m)||l.push(m),l),[]),Q=(l,m)=>(l[m.generationId]||(l[m.generationId]=0),l[m.generationId]|=m.bitflag,l),Ce=s.map(n).reduce(Q,{}),Te=r.map(n).reduce(Q,{}),Ae=a.reduce(Q,{}),$e=s.filter(l=>!l[pe]).map(l=>Object.getOwnPropertySymbols(l).includes(g)?l[g]:[l]).reduce((l,m)=>l.concat(m),[]),x=Object.assign(c,{archetypes:o,changed:h,components:s,notComponents:r,changedComponents:i,allComponents:a,masks:Ce,notMasks:Te,hasMasks:Ae,generations:xe,flatProps:$e,toRemove:f,entered:D,exited:Ee,shadows:[]});t[F].set(e,x),t[w].add(x),a.forEach(l=>{l.queries.add(x)}),r.length&&t[K].add(x);for(let l=0;l<Ye();l++){if(!t[b].has(l))continue;Z(t,x,l)&&ee(x,l)}},tt=(t,e)=>{const s=Symbol(),r=t.flatProps[e];return Ne(r,s),t.shadows[e]=r[s],r[s]},st=(t,e)=>{e&&(t.changed=[]);const{flatProps:s,shadows:r}=t;for(let i=0;i<t.dense.length;i++){const n=t.dense[i];let a=!1;for(let c=0;c<s.length;c++){const o=s[c],h=r[c]||tt(t,c);if(ArrayBuffer.isView(o[n])){for(let f=0;f<o[n].length;f++)if(o[n][f]!==h[n][f]){a=!0;break}h[n].set(o[n])}else o[n]!==h[n]&&(a=!0,h[n]=o[n])}a&&t.changed.push(n)}return t.changed},X=(...t)=>{let e,s,r,i;if(Array.isArray(t[0])&&(e=t[0]),e===void 0||e[y]!==void 0)return a=>a?a[R]:e[R];const n=function(a,c=!0){a[F].has(n)||et(a,n);const o=a[F].get(n);return nt(a),o.changedComponents.length?st(o,c):o.dense};return n[Se]=e,n[Ke]=s,n[Xe]=r,n[Ze]=i,n},Z=(t,e,s)=>{const{masks:r,notMasks:i,generations:n}=e;for(let a=0;a<n.length;a++){const c=n[a],o=r[c],h=i[c],f=t[v][c][s];if(h&&f&h||o&&(f&o)!==o)return!1}return!0},ee=(t,e)=>{t.toRemove.remove(e),t.entered.add(e),t.add(e)},rt=t=>{for(let e=t.toRemove.dense.length-1;e>=0;e--){const s=t.toRemove.dense[e];t.toRemove.remove(s),t.remove(s)}},nt=t=>{t[I].size&&(t[I].forEach(rt),t[I].clear())},ge=(t,e,s)=>{!e.has(s)||e.toRemove.has(s)||(e.toRemove.add(s),t[I].add(e),e.exited.add(s))},y=Symbol("componentMap"),_=(t,e)=>{const s=De(t,J());return t&&Object.keys(t).length,s},it=t=>{t[O]*=2,t[O]>=2**31&&(t[O]=1,t[v].push(new Uint32Array(t[te])))},G=(t,e)=>{if(!e)throw new Error("bitECS - Cannot register null or undefined component");const s=new Set,r=new Set,i=new Set;t[w].forEach(n=>{n.allComponents.includes(e)&&s.add(n)}),t[y].set(e,{generationId:t[v].length-1,bitflag:t[O],store:e,queries:s,notQueries:r,changedQueries:i}),it(t)},at=(t,e,s)=>{const r=t[y].get(e);if(!r)return!1;const{generationId:i,bitflag:n}=r;return(t[v][i][s]&n)===n},k=(t,e,s,r=!1)=>{if(s===void 0)throw new Error("bitECS - entity is undefined.");if(!t[b].has(s))throw new Error("bitECS - entity does not exist in the world.");if(t[y].has(e)||G(t,e),at(t,e,s))return;const i=t[y].get(e),{generationId:n,bitflag:a,queries:c,notQueries:o}=i;t[v][n][s]|=a,c.forEach(h=>{h.toRemove.remove(s);const f=Z(t,h,s);f&&(h.exited.remove(s),ee(h,s)),f||(h.entered.remove(s),ge(t,h,s))}),t[q].get(s).add(e),r&&je(e,s)},te=Symbol("size"),O=Symbol("bitflag"),ot=Symbol("archetypes"),be=Symbol("localEntities"),H=Symbol("localEntityLookup"),se=Symbol("manualEntityRecycling"),ct=(...t)=>{const e=typeof t[0]=="object"?t[0]:{},s=typeof t[0]=="number"?t[0]:typeof t[1]=="number"?t[1]:J();return ut(e,s),e},ut=(t,e=J())=>(t[te]=e,t[R]&&t[R].forEach(s=>ve(t,s)),t[v]=[new Uint32Array(e)],t[q]=new Map,t[ot]=[],t[b]=$(),t[R]=t[b].dense,t[O]=1,t[y]=new Map,t[F]=new Map,t[w]=new Set,t[K]=new Set,t[I]=new Set,t[be]=new Map,t[H]=new Map,t[se]=!1,t),he=(...t)=>e=>{let s=e;for(let r=0;r<t.length;r++){const i=t[r];s=i(s)}return s},E=C,A=(t=>(t[t.RED=0]="RED",t[t.BLUE=1]="BLUE",t))(A||{});const L=_({value:E.f32});function lt(t,e,s){k(t,L,e),L.value[e]=s}const T=_({x:E.f32,y:E.f32});function ht(t,e,s,r){k(t,T,e),T.x[e]=s,T.y[e]=r}class ft{constructor(e=new OffscreenCanvas(0,0)){u(this,"texture");u(this,"context");u(this,"events",{resize:new Set});this.texture=e,this.context=this.texture.getContext("2d")}resize(e=300,s=e){this.texture.width=e,this.texture.height=s,this.events.resize.forEach(r=>r({width:e,height:s}))}clear(){this.context.clearRect(0,0,this.texture.width,this.texture.height)}}class mt extends ft{constructor(e=document.createElement("canvas")){super(e)}isClientSize(){return this.texture.width==this.texture.clientWidth&&this.texture.height==this.texture.clientHeight}toClientSize(){this.resize(this.texture.clientWidth,this.texture.clientHeight)}}const N=_({value:E.ui8});function pt(t,e,s){k(t,N,e),N.value[e]=s}const d=_({x:E.f32,y:E.f32});function yt(t,e,s,r){k(t,d,e),d.x[e]=s,d.y[e]=r}const j=_({value:E.f32});function dt(t,e,s){k(t,j,e),j.value[e]=s}function vt(t,{x:e=0,y:s=0,radius:r=5,appearence:i=A.BLUE}={}){const n=He(t);return yt(t,n,e,s),dt(t,n,r),pt(t,n,i),n}function St(t){const e=X([d,T]);return()=>{for(const s of e(t))d.x[s]+=T.x[s],d.y[s]+=T.y[s]}}const re=[];re[A.RED]={fillColor:"#ff000055",strokeColor:"#ff0000"};re[A.BLUE]={fillColor:"#0000ff55",strokeColor:"#0000ff"};const gt=Math.PI*2;function bt(t,e){const s=X([d,j,N]);return()=>{e.clearRect(0,0,e.canvas.width,e.canvas.height);for(let r of s(t)){const i=re[N.value[r]];e.fillStyle=i.fillColor,e.strokeStyle=i.strokeColor,e.beginPath(),e.arc(d.x[r],d.y[r],j.value[r],0,gt),e.fill(),e.stroke()}}}function Et(t){const e=X([L]);return()=>{for(const s of e(t))L.value[s]-=1,L.value[s]<=0&&ve(t,s)}}class xt{constructor(e){u(this,"application");u(this,"screen");u(this,"world");u(this,"updateSystems");u(this,"renderSystems");u(this,"spawnRandomCircle",()=>{const e=vt(this.world,{x:this.screen.texture.width/2,y:this.screen.texture.height/2,appearence:Math.random()>.5?A.RED:A.BLUE});lt(this.world,e,Math.random()*300),ht(this.world,e,Math.random()-.5,Math.random()-.5)});this.application=e.application,this.screen=new mt,this.world=ct(),this.renderSystems=he(bt(this.world,this.screen.context)),this.updateSystems=he(St(this.world),Et(this.world))}async enter(){const e=this.application.timer.interval(this.spawnRandomCircle,0,33.333333333333336);return()=>{e.cancel()}}async leave(){}render(){this.screen.isClientSize()||this.screen.toClientSize(),this.renderSystems()}update(){this.updateSystems()}}async function Ct(){const t=new Pe,e=new xt({application:t});await t.enterScene(e)&&document.querySelector("#app").append(e.screen.texture)}document.addEventListener("DOMContentLoaded",Ct);
