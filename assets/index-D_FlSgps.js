var we=Object.defineProperty;var _e=(t,e,s)=>e in t?we(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var u=(t,e,s)=>_e(t,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function s(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(a){if(a.ep)return;a.ep=!0;const n=s(a);fetch(a.href,n)}})();class Le{constructor(){this.ids=[],this.values=[],this.length=0}clear(){this.length=0}push(e,s){let r=this.length++;for(;r>0;){const a=r-1>>1,n=this.values[a];if(s>=n)break;this.ids[r]=this.ids[a],this.values[r]=n,r=a}this.ids[r]=e,this.values[r]=s}pop(){if(this.length===0)return;const e=this.ids[0];if(this.length--,this.length>0){const s=this.ids[0]=this.ids[this.length],r=this.values[0]=this.values[this.length],a=this.length>>1;let n=0;for(;n<a;){let i=(n<<1)+1;const c=i+1;let o=this.ids[i],h=this.values[i];const f=this.values[c];if(c<this.length&&f<h&&(i=c,o=this.ids[c],h=f),h>=r)break;this.ids[n]=o,this.values[n]=h,n=i}this.ids[n]=s,this.values[n]=r}return e}peek(){if(this.length!==0)return this.ids[0]}peekValue(){if(this.length!==0)return this.values[0]}shrink(){this.ids.length=this.values.length=this.length}}class Ie{constructor(e){u(this,"template");u(this,"items",[]);this.template=e}create(){return this.items.pop()??new this.template}release(e){this.items.push(e)}}class U{constructor(){u(this,"run");u(this,"timer");u(this,"cancelled")}init(e,s){return this.run=s,this.timer=e,this.cancelled=!1,this}execute(){this.timer.pools.get(U).release(this),!this.cancelled&&this.run(this.timer)}cancel(){this.cancelled=!0}}class ae{constructor(){u(this,"run");u(this,"timer");u(this,"cancelled");u(this,"onFrameEnd",()=>this.timer.schedule(this,0))}init(e,s){return this.run=s,this.timer=e,this.cancelled=!1,this.timer.events.frameEnd.add(this.onFrameEnd),this}execute(){if(this.cancelled){this.timer.pools.get(U).release(this),this.timer.events.frameEnd.delete(this.onFrameEnd);return}this.run(this.timer)}cancel(){this.cancelled=!0}}class N{constructor(){u(this,"run");u(this,"timer");u(this,"cancelled");u(this,"interval")}init(e,s,r){return this.run=s,this.timer=e,this.interval=r,this.cancelled=!1,this}execute(){if(this.cancelled){this.timer.pools.get(N).release(this);return}this.timer.schedule(this,this.interval),this.run(this.timer)}cancel(){this.cancelled=!0}}class Oe{constructor(){u(this,"executionTime",0);u(this,"lastExecutionTime",0);u(this,"frameExecutionTime",0);u(this,"speed",0);u(this,"playing",!1);u(this,"requestID",-1);u(this,"queue",new Le);u(this,"pools",new Map);u(this,"events",{frameStart:new Set,frameEnd:new Set});u(this,"loop",(e=performance.now())=>{this.requestID=requestAnimationFrame(this.loop),this.update(e)});[U,N,ae].forEach(e=>this.pools.set(e,new Ie(e)))}get now(){return this.executionTime}schedule(e,s=1e3){this.queue.push(e,this.executionTime+s)}animation(e,s=1e3){const r=this.pools.get(ae).create();return r.init(this,e),this.schedule(r,s),r}delay(e,s=1e3){const r=this.pools.get(U).create();return r.init(this,e),this.schedule(r,s),r}interval(e,s=1e3,r=1e3){const a=this.pools.get(N).create();return a.init(this,e,r),this.schedule(a,s),a}update(e=performance.now()){const s=e-this.lastExecutionTime;this.lastExecutionTime=e,this.events.frameStart.forEach(r=>r(this)),this.frameExecutionTime+=s*this.speed;do{const r=this.queue.peekValue()??1/0;if(r>this.frameExecutionTime)break;this.executionTime=r,this.queue.pop().execute(this)}while(!0);this.executionTime=this.frameExecutionTime,this.events.frameEnd.forEach(r=>r(this))}play(e=1){this.playing||e<0||(this.playing=!0,this.speed=e,this.lastExecutionTime=performance.now(),this.requestID=requestAnimationFrame(this.loop))}stop(){this.playing&&(this.playing=!1,cancelAnimationFrame(this.requestID),this.frameExecutionTime=this.executionTime)}clear(){this.queue.clear()}}class Ue{constructor({autoStart:e=!0,frameRate:s=1e3/60}={}){u(this,"timer");u(this,"_scenes",new Set);u(this,"_cleanups",new Map);u(this,"render",()=>this._scenes.forEach(e=>e.render()));u(this,"update",()=>this._scenes.forEach(e=>e.update()));this.timer=new Oe,this.timer.animation(this.render,0),this.timer.interval(this.update,0,s),e&&this.timer.play()}async enterScene(e){if(this._scenes.has(e))return!1;const s=await e.enter();return this._scenes.add(e),s&&this._cleanups.set(e,s),!0}async leaveScene(e){if(!this._scenes.has(e))return!1;const s=this._cleanups.get(e);return s&&(await s(),this._cleanups.delete(e)),await e.leave(),this._scenes.delete(e),!0}}var A={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},oe={i8:"Int8",ui8:"Uint8",ui8c:"Uint8Clamped",i16:"Int16",ui16:"Uint16",i32:"Int32",ui32:"Uint32",eid:"Uint32",f32:"Float32",f64:"Float64"},E={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},ce={uint8:2**8,uint16:2**16,uint32:2**32},Be=t=>e=>Math.ceil(e/t)*t,Pe=Be(4),Ne=Symbol("storeRef"),G=Symbol("storeSize"),Fe=Symbol("storeMaps"),x=Symbol("storeFlattened"),B=Symbol("storeBase"),ze=Symbol("storeType"),pe=Symbol("storeArrayElementCounts"),P=Symbol("storeSubarrays"),me=Symbol("subarrayCursors"),De=Symbol("subarray"),Y=Symbol("parentArray"),ve=Symbol("tagStore"),ue=Symbol("indexType"),le=Symbol("indexBytes"),ge=Symbol("isEidType"),m={},je=(t,e)=>{if(ArrayBuffer.isView(t))t[e]=t.slice(0);else{const s=t[Y].slice(0);t[e]=t.map((r,a)=>{const{length:n}=t[a],i=n*a,c=i+n;return s.subarray(i,c)})}},qe=(t,e)=>{t[x]&&t[x].forEach(s=>{ArrayBuffer.isView(s)?s[e]=0:s[e].fill(0)})},Ke=(t,e)=>{const s=e*E[t].BYTES_PER_ELEMENT,r=new ArrayBuffer(s),a=new E[t](r);return a[ge]=t===A.eid,a},Qe=(t,e,s)=>{const r=t[G],a=Array(r).fill(0);a[ze]=e,a[ge]=e===A.eid;const n=t[me],i=s<=ce.uint8?A.ui8:s<=ce.uint16?A.ui16:A.ui32;if(!s)throw new Error("bitECS - Must define component array length");if(!E[e])throw new Error(`bitECS - Invalid component array property type ${e}`);if(!t[P][e]){const h=t[pe][e],f=new E[e](Pe(h*r));f[ue]=oe[i],f[le]=E[i].BYTES_PER_ELEMENT,t[P][e]=f}const c=n[e],o=c+r*s;n[e]=o,a[Y]=t[P][e].subarray(c,o);for(let h=0;h<r;h++){const f=s*h,V=f+s;a[h]=a[Y].subarray(f,V),a[h][ue]=oe[i],a[h][le]=E[i].BYTES_PER_ELEMENT,a[h][De]=!0}return a},he=t=>Array.isArray(t)&&typeof t[0]=="string"&&typeof t[1]=="number",Ve=(t,e)=>{const s=Symbol("store");if(!t||!Object.keys(t).length)return m[s]={[G]:e,[ve]:!0,[B]:()=>m[s]},m[s];t=JSON.parse(JSON.stringify(t));const r={},a=i=>{const c=Object.keys(i);for(const o of c)he(i[o])?(r[i[o][0]]||(r[i[o][0]]=0),r[i[o][0]]+=i[o][1]):i[o]instanceof Object&&a(i[o])};a(t);const n={[G]:e,[Fe]:{},[P]:{},[Ne]:s,[me]:Object.keys(E).reduce((i,c)=>({...i,[c]:0}),{}),[x]:[],[pe]:r};if(t instanceof Object&&Object.keys(t).length){const i=(c,o)=>{if(typeof c[o]=="string")c[o]=Ke(c[o],e),c[o][B]=()=>m[s],n[x].push(c[o]);else if(he(c[o])){const[h,f]=c[o];c[o]=Qe(n,h,f),c[o][B]=()=>m[s],n[x].push(c[o])}else c[o]instanceof Object&&(c[o]=Object.keys(c[o]).reduce(i,c[o]));return c};return m[s]=Object.assign(Object.keys(t).reduce(i,t),n),m[s][B]=()=>m[s],m[s]}},k=()=>{const t=[],e=[];t.sort=function(i){const c=Array.prototype.sort.call(this,i);for(let o=0;o<t.length;o++)e[t[o]]=o;return c};const s=i=>t[e[i]]===i;return{add:i=>{s(i)||(e[i]=t.push(i)-1)},remove:i=>{if(!s(i))return;const c=e[i],o=t.pop();o!==i&&(t[c]=o,e[o]=c)},has:s,sparse:e,dense:t,reset:()=>{t.length=0,e.length=0}}},b=Symbol("entityMasks"),q=Symbol("entityComponents"),C=Symbol("entitySparseSet"),_=Symbol("entityArray"),We=1e5,H=0,Se=We,Z=()=>Se,w=[],Ge=.01,Ye=Ge,He=()=>H,Je=new Map,Xe=t=>{const e=t[ne]?w.length?w.shift():H++:w.length>Math.round(Se*Ye)?w.shift():H++;if(e>t[re])throw new Error("bitECS - max entities reached");return t[C].add(e),Je.set(e,t),t[ee].forEach(s=>{te(t,s,e)&&se(s,e)}),t[q].set(e,new Set),e},be=(t,e)=>{if(t[C].has(e)){t[K].forEach(s=>{xe(t,s,e)}),t[ne]||w.push(e),t[C].remove(e),t[q].delete(e),t[Ce].delete(t[X].get(e)),t[X].delete(e);for(let s=0;s<t[b].length;s++)t[b][s][e]=0}},Ze=Symbol("$modifier"),K=Symbol("queries"),ee=Symbol("notQueries"),et=Symbol("queryAny"),tt=Symbol("queryAll"),st=Symbol("queryNone"),F=Symbol("queryMap"),L=Symbol("$dirtyQueries"),Ee=Symbol("queryComponents"),rt=(t,e)=>{const s=[],r=[],a=[];e[Ee].forEach(l=>{if(typeof l=="function"&&l[Ze]){const[y,ie]=l();t[v].has(y)||J(t,y),ie==="not"&&r.push(y),ie==="changed"&&(a.push(y),s.push(y))}else t[v].has(l)||J(t,l),s.push(l)});const n=l=>t[v].get(l),i=s.concat(r).map(n),c=k(),o=[],h=[],f=k(),V=k(),Te=k(),Ae=i.map(l=>l.generationId).reduce((l,y)=>(l.includes(y)||l.push(y),l),[]),W=(l,y)=>(l[y.generationId]||(l[y.generationId]=0),l[y.generationId]|=y.bitflag,l),Me=s.map(n).reduce(W,{}),$e=r.map(n).reduce(W,{}),Re=i.reduce(W,{}),ke=s.filter(l=>!l[ve]).map(l=>Object.getOwnPropertySymbols(l).includes(x)?l[x]:[l]).reduce((l,y)=>l.concat(y),[]),T=Object.assign(c,{archetypes:o,changed:h,components:s,notComponents:r,changedComponents:a,allComponents:i,masks:Me,notMasks:$e,hasMasks:Re,generations:Ae,flatProps:ke,toRemove:f,entered:V,exited:Te,shadows:[]});t[F].set(e,T),t[K].add(T),i.forEach(l=>{l.queries.add(T)}),r.length&&t[ee].add(T);for(let l=0;l<He();l++){if(!t[C].has(l))continue;te(t,T,l)&&se(T,l)}},nt=(t,e)=>{const s=Symbol(),r=t.flatProps[e];return je(r,s),t.shadows[e]=r[s],r[s]},it=(t,e)=>{e&&(t.changed=[]);const{flatProps:s,shadows:r}=t;for(let a=0;a<t.dense.length;a++){const n=t.dense[a];let i=!1;for(let c=0;c<s.length;c++){const o=s[c],h=r[c]||nt(t,c);if(ArrayBuffer.isView(o[n])){for(let f=0;f<o[n].length;f++)if(o[n][f]!==h[n][f]){i=!0;break}h[n].set(o[n])}else o[n]!==h[n]&&(i=!0,h[n]=o[n])}i&&t.changed.push(n)}return t.changed},z=(...t)=>{let e,s,r,a;if(Array.isArray(t[0])&&(e=t[0]),e===void 0||e[v]!==void 0)return i=>i?i[_]:e[_];const n=function(i,c=!0){i[F].has(n)||rt(i,n);const o=i[F].get(n);return ot(i),o.changedComponents.length?it(o,c):o.dense};return n[Ee]=e,n[et]=s,n[tt]=r,n[st]=a,n},te=(t,e,s)=>{const{masks:r,notMasks:a,generations:n}=e;for(let i=0;i<n.length;i++){const c=n[i],o=r[c],h=a[c],f=t[b][c][s];if(h&&f&h||o&&(f&o)!==o)return!1}return!0},se=(t,e)=>{t.toRemove.remove(e),t.entered.add(e),t.add(e)},at=t=>{for(let e=t.toRemove.dense.length-1;e>=0;e--){const s=t.toRemove.dense[e];t.toRemove.remove(s),t.remove(s)}},ot=t=>{t[L].size&&(t[L].forEach(at),t[L].clear())},xe=(t,e,s)=>{!e.has(s)||e.toRemove.has(s)||(e.toRemove.add(s),t[L].add(e),e.exited.add(s))},v=Symbol("componentMap"),$=(t,e)=>{const s=Ve(t,Z());return t&&Object.keys(t).length,s},ct=t=>{t[I]*=2,t[I]>=2**31&&(t[I]=1,t[b].push(new Uint32Array(t[re])))},J=(t,e)=>{if(!e)throw new Error("bitECS - Cannot register null or undefined component");const s=new Set,r=new Set,a=new Set;t[K].forEach(n=>{n.allComponents.includes(e)&&s.add(n)}),t[v].set(e,{generationId:t[b].length-1,bitflag:t[I],store:e,queries:s,notQueries:r,changedQueries:a}),ct(t)},ut=(t,e,s)=>{const r=t[v].get(e);if(!r)return!1;const{generationId:a,bitflag:n}=r;return(t[b][a][s]&n)===n},R=(t,e,s,r=!1)=>{if(s===void 0)throw new Error("bitECS - entity is undefined.");if(!t[C].has(s))throw new Error("bitECS - entity does not exist in the world.");if(t[v].has(e)||J(t,e),ut(t,e,s))return;const a=t[v].get(e),{generationId:n,bitflag:i,queries:c,notQueries:o}=a;t[b][n][s]|=i,c.forEach(h=>{h.toRemove.remove(s);const f=te(t,h,s);f&&(h.exited.remove(s),se(h,s)),f||(h.entered.remove(s),xe(t,h,s))}),t[q].get(s).add(e),r&&qe(e,s)},re=Symbol("size"),I=Symbol("bitflag"),lt=Symbol("archetypes"),Ce=Symbol("localEntities"),X=Symbol("localEntityLookup"),ne=Symbol("manualEntityRecycling"),ht=(...t)=>{const e=typeof t[0]=="object"?t[0]:{},s=typeof t[0]=="number"?t[0]:typeof t[1]=="number"?t[1]:Z();return ft(e,s),e},ft=(t,e=Z())=>(t[re]=e,t[_]&&t[_].forEach(s=>be(t,s)),t[b]=[new Uint32Array(e)],t[q]=new Map,t[lt]=[],t[C]=k(),t[_]=t[C].dense,t[I]=1,t[v]=new Map,t[F]=new Map,t[K]=new Set,t[ee]=new Set,t[L]=new Set,t[Ce]=new Map,t[X]=new Map,t[ne]=!1,t),fe=(...t)=>e=>{let s=e;for(let r=0;r<t.length;r++){const a=t[r];s=a(s)}return s},g=A,S=(t=>(t[t.RED=0]="RED",t[t.BLUE=1]="BLUE",t[t.GREEN=2]="GREEN",t))(S||{});const M=$({x:g.f32,y:g.f32});function yt(t,e,s,r){R(t,M,e),M.x[e]=s,M.y[e]=r}const p=$({x:g.f32,y:g.f32});function dt(t,e,s,r){R(t,p,e),p.x[e]=s,p.y[e]=r}const O=$({value:g.f32});function pt(t,e,s){R(t,O,e),O.value[e]=s}const d=$({x:g.f32,y:g.f32});function ye(t,e,s,r){R(t,d,e),d.x[e]=s,d.y[e]=r}class mt{constructor(){u(this,"_states");u(this,"onKeyDown",e=>{this._states.set(e.code,!0)});u(this,"onKeyUp",e=>{this._states.set(e.code,!1)});u(this,"onBlur",e=>{this._states.forEach((s,r)=>this._states.set(r,!1))});this._states=new Map}getState(e){return this._states.get(e)??!1}attach(e){e.addEventListener("keydown",this.onKeyDown),e.addEventListener("keyup",this.onKeyUp),window.addEventListener("blur",this.onBlur)}detach(e){e.removeEventListener("keydown",this.onKeyDown),e.removeEventListener("keyup",this.onKeyUp),window.removeEventListener("blur",this.onBlur)}}class vt{constructor(e=new OffscreenCanvas(0,0)){u(this,"texture");u(this,"context");u(this,"events",{resize:new Set});this.texture=e,this.context=this.texture.getContext("2d")}resize(e=300,s=e){this.texture.width=e,this.texture.height=s,this.events.resize.forEach(r=>r({width:e,height:s}))}clear(){this.context.clearRect(0,0,this.texture.width,this.texture.height)}}class gt extends vt{constructor(e=document.createElement("canvas")){super(e)}isClientSize(){return this.texture.width==this.texture.clientWidth&&this.texture.height==this.texture.clientHeight}toClientSize(){this.resize(this.texture.clientWidth,this.texture.clientHeight)}}const D=$({value:g.ui8});function St(t,e,s){R(t,D,e),D.value[e]=s}const j=$({value:g.f32});function bt(t,e,s){R(t,j,e),j.value[e]=s}function de(t,{x:e=0,y:s=0,radius:r=5,appearence:a=S.BLUE}={}){const n=Xe(t);return dt(t,n,e,s),bt(t,n,r),St(t,n,a),n}function Et(t){const e=z([p,d]),s=z([d,M]);return()=>{for(const r of e(t))p.x[r]+=d.x[r],p.y[r]+=d.y[r];for(const r of s(t))d.x[r]*=M.x[r],d.y[r]*=M.y[r]}}const Q=[];Q[S.RED]={fillColor:"#ff000055",strokeColor:"#ff0000"};Q[S.BLUE]={fillColor:"#0000ff55",strokeColor:"#0000ff"};Q[S.GREEN]={fillColor:"#00ff0055",strokeColor:"#00ff00"};const xt=Math.PI*2;function Ct({world:t,context:e,camera:s}){const r=z([p,j,D]);return()=>{e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save();const{width:a,height:n}=e.canvas;e.translate(a/2,n/2),e.scale(s.scale,s.scale),e.translate(-s.x,-s.y);for(let i of r(t)){const c=Q[D.value[i]];e.fillStyle=c.fillColor,e.strokeStyle=c.strokeColor,e.beginPath(),e.arc(p.x[i],p.y[i],j.value[i],0,xt),e.fill(),e.stroke()}e.restore()}}class Tt{constructor({x:e=0,y:s=e,scale:r=1}={}){u(this,"x");u(this,"y");u(this,"scale");this.x=e,this.y=s,this.scale=r}}function At(t){const e=z([O]);return()=>{for(const s of e(t))O.value[s]-=1,O.value[s]<=0&&be(t,s)}}class Mt{constructor(e){u(this,"application");u(this,"screen");u(this,"world");u(this,"camera");u(this,"keyboard");u(this,"player");u(this,"updateSystems");u(this,"renderSystems");u(this,"spawnRandomCircle",()=>{const e=de(this.world,{appearence:Math.random()>.5?S.RED:S.BLUE});pt(this.world,e,Math.random()*300),ye(this.world,e,Math.random()-.5,Math.random()-.5)});this.application=e.application,this.screen=new gt,this.world=ht(),this.camera=new Tt,this.keyboard=new mt,this.player=de(this.world,{appearence:S.GREEN}),ye(this.world,this.player,0,0),yt(this.world,this.player,.9,.9),this.renderSystems=fe(Ct({world:this.world,context:this.screen.context,camera:this.camera})),this.updateSystems=fe(Et(this.world),At(this.world))}async enter(){const e=this.application.timer.interval(this.spawnRandomCircle,0,33.333333333333336);return this.keyboard.attach(document.body),()=>{e.cancel()}}async leave(){this.keyboard.detach(document.body)}render(){this.screen.isClientSize()||this.screen.toClientSize();const s=p.x[this.player]-this.camera.x,r=p.y[this.player]-this.camera.y;this.camera.x+=s*.1,this.camera.y+=r*.1,this.renderSystems()}update(){(this.keyboard.getState("ArrowRight")||this.keyboard.getState("KeyD"))&&(d.x[this.player]+=1),(this.keyboard.getState("ArrowLeft")||this.keyboard.getState("KeyA"))&&(d.x[this.player]-=1),(this.keyboard.getState("ArrowUp")||this.keyboard.getState("KeyW"))&&(d.y[this.player]-=1),(this.keyboard.getState("ArrowDown")||this.keyboard.getState("KeyS"))&&(d.y[this.player]+=1),this.updateSystems()}}async function $t(){const t=new Ue,e=new Mt({application:t});await t.enterScene(e)&&document.querySelector("#app").append(e.screen.texture)}document.addEventListener("DOMContentLoaded",$t);
